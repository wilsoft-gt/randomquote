import * as tslib_1 from "tslib";
import { FormArray } from "@angular/forms";
import { VALUE_CHANGED_SYNC, PATCH } from "../const/app.const";
import { isMatched, clone } from './entity.service';
import { ObjectMaker } from '../util/object-maker';
var PROP_ARRAY = "propArray";
var RxFormArray = /** @class */ (function (_super) {
    tslib_1.__extends(RxFormArray, _super);
    function RxFormArray(arrayObject, controls, validatorOrOpts, asyncValidator, arrayConfig) {
        var _this = _super.call(this, controls, validatorOrOpts, asyncValidator) || this;
        _this.arrayObject = arrayObject;
        _this.arrayConfig = arrayConfig;
        _this._isModified = false;
        _this._modified = [];
        _this.cloneObject(arrayObject);
        return _this;
    }
    Object.defineProperty(RxFormArray.prototype, "isModified", {
        get: function () {
            return this._isModified;
        },
        enumerable: true,
        configurable: true
    });
    RxFormArray.prototype.push = function (control) {
        var formGroup = this.root;
        if (this.arrayObject)
            if (control.modelInstance)
                this.arrayObject.push(control.modelInstance);
        _super.prototype.push.call(this, control);
        if (formGroup[VALUE_CHANGED_SYNC])
            formGroup.valueChangedSync();
        this.patch();
        this.checkValidation();
    };
    RxFormArray.prototype.patch = function () {
        this.checkModification();
        if (this.parent)
            this.parent[PATCH]();
    };
    RxFormArray.prototype.resetForm = function (options) {
        if (options && options.index >= 0 && options.groupOption) {
            this.controls[options.index].resetForm(options.groupOption);
        }
        else {
            for (var i = 0; i < this._baseValue.length; i++) {
                if (this.controls[i] !== undefined)
                    this.controls[i].resetForm({ value: this._baseValue[i] });
                else if (options && options.pushFunction) {
                    var formGroup = options.pushFunction(this._baseValue[i]);
                    this.push(formGroup);
                }
            }
        }
    };
    RxFormArray.prototype.commit = function () {
        var e_1, _a;
        this._baseValue = [];
        try {
            for (var _b = tslib_1.__values(this.controls), _c = _b.next(); !_c.done; _c = _b.next()) {
                var formGroup = _c.value;
                formGroup.commit();
                this._baseValue.push(clone(formGroup.value));
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_1) throw e_1.error; }
        }
        this.patch();
    };
    RxFormArray.prototype.removeAt = function (index) {
        var formGroup = this.root;
        this.arrayObject.splice(index, 1);
        _super.prototype.removeAt.call(this, index);
        if (formGroup[VALUE_CHANGED_SYNC])
            formGroup.valueChangedSync();
        this.patch();
        this.checkValidation();
    };
    RxFormArray.prototype.checkValidation = function () {
        var _this = this;
        setTimeout(function () {
            if (_this.arrayConfig != undefined && _this.arrayConfig.allowMaxIndex && _this.length > _this.arrayConfig.allowMaxIndex)
                _this.setErrors(ObjectMaker.toJson(PROP_ARRAY, _this.arrayConfig, [_this.length, _this.arrayConfig.allowMaxIndex]));
            else if (_this.errors && _this.errors[PROP_ARRAY])
                delete _this.errors[PROP_ARRAY];
        });
    };
    RxFormArray.prototype.checkModification = function () {
        this._isModified = !(this._baseValue.length == this.controls.length);
        if (!this._isModified)
            for (var i = 0; i < this.controls.length; i++) {
                this._isModified = isMatched(this._baseValue[i], this.controls[i].value);
                if (this._isModified)
                    break;
            }
    };
    RxFormArray.prototype.cloneObject = function (value) {
        var e_2, _a;
        this._baseValue = [];
        try {
            for (var value_1 = tslib_1.__values(value), value_1_1 = value_1.next(); !value_1_1.done; value_1_1 = value_1.next()) {
                var row = value_1_1.value;
                this._baseValue.push(clone(row));
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (value_1_1 && !value_1_1.done && (_a = value_1.return)) _a.call(value_1);
            }
            finally { if (e_2) throw e_2.error; }
        }
    };
    return RxFormArray;
}(FormArray));
export { RxFormArray };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicngtZm9ybS1hcnJheS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0ByeHdlYi9yZWFjdGl2ZS1mb3JtLXZhbGlkYXRvcnMvIiwic291cmNlcyI6WyJzZXJ2aWNlcy9yeC1mb3JtLWFycmF5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLGtCQUFrQixFQUFFLEtBQUssRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFFbkQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFBO0FBQ2xELElBQU0sVUFBVSxHQUFXLFdBQVcsQ0FBQztBQUN2QztJQUFpQyx1Q0FBUztJQUl0QyxxQkFBb0IsV0FBa0IsRUFBRSxRQUFRLEVBQUUsZUFBcUIsRUFBRSxjQUFvQixFQUFVLFdBQXdEO1FBQS9KLFlBQ0ksa0JBQU0sUUFBUSxFQUFFLGVBQWUsRUFBRSxjQUFjLENBQUMsU0FFbkQ7UUFIbUIsaUJBQVcsR0FBWCxXQUFXLENBQU87UUFBaUUsaUJBQVcsR0FBWCxXQUFXLENBQTZDO1FBRnZKLGlCQUFXLEdBQVksS0FBSyxDQUFDO1FBQzdCLGVBQVMsR0FBVSxFQUFFLENBQUM7UUFHMUIsS0FBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQzs7SUFDbEMsQ0FBQztJQUVELHNCQUFJLG1DQUFVO2FBQWQ7WUFDSSxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7UUFDNUIsQ0FBQzs7O09BQUE7SUFFRCwwQkFBSSxHQUFKLFVBQUssT0FBVztRQUNaLElBQUksU0FBUyxHQUFPLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDOUIsSUFBRyxJQUFJLENBQUMsV0FBVztZQUNmLElBQUcsT0FBTyxDQUFDLGFBQWE7Z0JBQ3BCLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLE9B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R3pDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRm9ybUFycmF5IH0gZnJvbSBcIkBhbmd1bGFyL2Zvcm1zXCI7XHJcbmltcG9ydCB7IFZBTFVFX0NIQU5HRURfU1lOQywgUEFUQ0ggfSBmcm9tIFwiLi4vY29uc3QvYXBwLmNvbnN0XCI7XHJcbmltcG9ydCB7IGlzTWF0Y2hlZCwgY2xvbmUgfSBmcm9tICcuL2VudGl0eS5zZXJ2aWNlJ1xyXG5pbXBvcnQgeyBSZXNldEZvcm1UeXBlIH0gZnJvbSBcIi4uL2VudW1zL3Jlc2V0LXR5cGVcIjtcclxuaW1wb3J0IHsgT2JqZWN0TWFrZXIgfSBmcm9tICcuLi91dGlsL29iamVjdC1tYWtlcidcclxuY29uc3QgUFJPUF9BUlJBWTogc3RyaW5nID0gXCJwcm9wQXJyYXlcIjtcclxuZXhwb3J0IGNsYXNzIFJ4Rm9ybUFycmF5IGV4dGVuZHMgRm9ybUFycmF5IHtcclxuICAgIHByaXZhdGUgX2Jhc2VWYWx1ZTogYW55W107XHJcbiAgICBwcml2YXRlIF9pc01vZGlmaWVkOiBib29sZWFuID0gZmFsc2U7XHJcbiAgICBwcml2YXRlIF9tb2RpZmllZDogYW55W10gPSBbXTtcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgYXJyYXlPYmplY3Q6IGFueVtdLCBjb250cm9scywgdmFsaWRhdG9yT3JPcHRzPzogYW55LCBhc3luY1ZhbGlkYXRvcj86IGFueSwgcHJpdmF0ZSBhcnJheUNvbmZpZz86IHthbGxvd01heEluZGV4PzpudW1iZXIsbWVzc2FnZUtleT86c3RyaW5nfSl7XHJcbiAgICAgICAgc3VwZXIoY29udHJvbHMsIHZhbGlkYXRvck9yT3B0cywgYXN5bmNWYWxpZGF0b3IpO1xyXG4gICAgICAgIHRoaXMuY2xvbmVPYmplY3QoYXJyYXlPYmplY3QpOyAgICAgICAgXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGlzTW9kaWZpZWQoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2lzTW9kaWZpZWQ7XHJcbiAgICB9XHJcblxyXG4gICAgcHVzaChjb250cm9sOmFueSl7XHJcbiAgICAgICAgbGV0IGZvcm1Hcm91cDphbnkgPSB0aGlzLnJvb3Q7XHJcbiAgICAgICAgaWYodGhpcy5hcnJheU9iamVjdClcclxuICAgICAgICAgICAgaWYoY29udHJvbC5tb2RlbEluc3RhbmNlKVxyXG4gICAgICAgICAgICAgICAgdGhpcy5hcnJheU9iamVjdC5wdXNoKGNvbnRyb2wubW9kZWxJbnN0YW5jZSk7XHJcbiAgICAgICAgc3VwZXIucHVzaChjb250cm9sKTtcclxuICAgICAgICBpZihmb3JtR3JvdXBbVkFMVUVfQ0hBTkdFRF9TWU5DXSlcclxuICAgICAgICAgICAgZm9ybUdyb3VwLnZhbHVlQ2hhbmdlZFN5bmMoKVxyXG4gICAgICAgIHRoaXMucGF0Y2goKVxyXG4gICAgICAgIHRoaXMuY2hlY2tWYWxpZGF0aW9uKCkgXHJcbiAgICB9XHJcblxyXG4gICAgcGF0Y2goKSB7XHJcbiAgICAgICAgdGhpcy5jaGVja01vZGlmaWNhdGlvbigpO1xyXG4gICAgICAgIGlmICh0aGlzLnBhcmVudClcclxuICAgICAgICAgICAgdGhpcy5wYXJlbnRbUEFUQ0hdKCk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHJlc2V0Rm9ybShvcHRpb25zPzoge1xyXG4gICAgICAgIGluZGV4OiBudW1iZXIsXHJcbiAgICAgICAgZ3JvdXBPcHRpb246IHtcclxuICAgICAgICAgICAgcmVzZXRUeXBlPzogUmVzZXRGb3JtVHlwZSxcclxuICAgICAgICAgICAgd2l0aD86IHN0cmluZ1tdLFxyXG4gICAgICAgICAgICB2YWx1ZT86IHsgW2tleTogc3RyaW5nXTogYW55IH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIHB1c2hGdW5jdGlvbjogKHZhbHVlOk9iamVjdCkgPT4gYm9vbGVhbjtcclxuICAgIH0pIHtcclxuICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmluZGV4ID49IDAgJiYgb3B0aW9ucy5ncm91cE9wdGlvbikge1xyXG4gICAgICAgICAgICAoPGFueT50aGlzLmNvbnRyb2xzW29wdGlvbnMuaW5kZXhdKS5yZXNldEZvcm0ob3B0aW9ucy5ncm91cE9wdGlvbilcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX2Jhc2VWYWx1ZS5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuY29udHJvbHNbaV0gIT09IHVuZGVmaW5lZClcclxuICAgICAgICAgICAgICAgICAgICAoPGFueT50aGlzLmNvbnRyb2xzW2ldKS5yZXNldEZvcm0oeyB2YWx1ZTogdGhpcy5fYmFzZVZhbHVlW2ldIH0pO1xyXG4gICAgICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMucHVzaEZ1bmN0aW9uKVxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGZvcm1Hcm91cCA9IG9wdGlvbnMucHVzaEZ1bmN0aW9uKHRoaXMuX2Jhc2VWYWx1ZVtpXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVzaChmb3JtR3JvdXApO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG5cclxuICAgIGNvbW1pdCgpIHtcclxuICAgICAgICB0aGlzLl9iYXNlVmFsdWUgPSBbXVxyXG4gICAgICAgIGZvciAobGV0IGZvcm1Hcm91cCBvZiB0aGlzLmNvbnRyb2xzKSB7XHJcbiAgICAgICAgICAgICg8YW55PmZvcm1Hcm91cCkuY29tbWl0KCk7XHJcbiAgICAgICAgICAgIHRoaXMuX2Jhc2VWYWx1ZS5wdXNoKGNsb25lKGZvcm1Hcm91cC52YWx1ZSkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnBhdGNoKCk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHJlbW92ZUF0KGluZGV4Om51bWJlcil7XHJcbiAgICAgICAgbGV0IGZvcm1Hcm91cDphbnkgPSB0aGlzLnJvb3Q7XHJcbiAgICAgICAgdGhpcy5hcnJheU9iamVjdC5zcGxpY2UoaW5kZXgsMSk7XHJcbiAgICAgICAgc3VwZXIucmVtb3ZlQXQoaW5kZXgpO1xyXG4gICAgICAgIGlmKGZvcm1Hcm91cFtWQUxVRV9DSEFOR0VEX1NZTkNdKVxyXG4gICAgICAgICAgICBmb3JtR3JvdXAudmFsdWVDaGFuZ2VkU3luYygpXHJcbiAgICAgICAgdGhpcy5wYXRjaCgpXHJcbiAgICAgICAgdGhpcy5jaGVja1ZhbGlkYXRpb24oKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNoZWNrVmFsaWRhdGlvbigpIHtcclxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuYXJyYXlDb25maWcgIT0gdW5kZWZpbmVkICYmIHRoaXMuYXJyYXlDb25maWcuYWxsb3dNYXhJbmRleCAmJiB0aGlzLmxlbmd0aCA+IHRoaXMuYXJyYXlDb25maWcuYWxsb3dNYXhJbmRleClcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0RXJyb3JzKE9iamVjdE1ha2VyLnRvSnNvbihQUk9QX0FSUkFZLCB0aGlzLmFycmF5Q29uZmlnLCBbdGhpcy5sZW5ndGgsIHRoaXMuYXJyYXlDb25maWcuYWxsb3dNYXhJbmRleF0pKTtcclxuICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5lcnJvcnMgJiYgdGhpcy5lcnJvcnNbUFJPUF9BUlJBWV0pXHJcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5lcnJvcnNbUFJPUF9BUlJBWV07XHJcbiAgICAgICAgfSlcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNoZWNrTW9kaWZpY2F0aW9uKCkge1xyXG4gICAgICAgIHRoaXMuX2lzTW9kaWZpZWQgPSAhKHRoaXMuX2Jhc2VWYWx1ZS5sZW5ndGggPT0gdGhpcy5jb250cm9scy5sZW5ndGgpO1xyXG4gICAgICAgIGlmICghdGhpcy5faXNNb2RpZmllZClcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmNvbnRyb2xzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9pc01vZGlmaWVkID0gaXNNYXRjaGVkKHRoaXMuX2Jhc2VWYWx1ZVtpXSwgdGhpcy5jb250cm9sc1tpXS52YWx1ZSlcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLl9pc01vZGlmaWVkKVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjbG9uZU9iamVjdCh2YWx1ZTogYW55W10pIHtcclxuICAgICAgICB0aGlzLl9iYXNlVmFsdWUgPSBbXTtcclxuICAgICAgICBmb3IgKGxldCByb3cgb2YgdmFsdWUpIHtcclxuICAgICAgICAgICAgdGhpcy5fYmFzZVZhbHVlLnB1c2goY2xvbmUocm93KSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcbn1cclxuIl19