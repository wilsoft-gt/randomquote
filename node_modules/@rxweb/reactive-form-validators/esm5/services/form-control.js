import * as tslib_1 from "tslib";
import { FormControl } from "@angular/forms";
import { ObjectMaker } from "../util/object-maker";
import { MESSAGE, CONTROLS_ERROR, VALUE_CHANGED_SYNC } from '../const';
import { ApplicationUtil } from '../util/app-util';
import { DisableProvider } from '../domain/disable-provider';
import { RXCODE, MODEL_INSTANCE, PATCH } from "../const/app.const";
import { DECORATORS } from "../const/decorators.const";
import { defaultContainer } from "../core/defaultContainer";
import { SANITIZERS } from "../util/sanitizers";
import { ErrorMessageBindingStrategy } from "../enums";
import { ReactiveFormConfig } from "../util/reactive-form-config";
var DIRTY = "dirty";
var TOUCHED = "touched";
var UNTOUCHED = "untouched";
var PRISTINE = "pristine";
var PENDING = "pending";
var RxFormControl = /** @class */ (function (_super) {
    tslib_1.__extends(RxFormControl, _super);
    function RxFormControl(formState, validator, asyncValidator, entityObject, baseObject, controlName, _sanitizers) {
        var _this = _super.call(this, formState, validator, asyncValidator) || this;
        _this.entityObject = entityObject;
        _this.baseObject = baseObject;
        _this._sanitizers = _sanitizers;
        _this._errorMessages = [];
        _this._childColumns = [];
        _this._refDisableControls = [];
        _this._refMessageControls = [];
        _this._refClassNameControls = [];
        _this._isPassedExpression = false;
        _this._baseValue = formState === undefined ? null : _this.getFormState(formState);
        _this._isModified = false;
        _this.keyName = controlName;
        _this._errorMessageBindingStrategy = ReactiveFormConfig.get("reactiveForm.errorMessageBindingStrategy");
        if (_this._sanitizers) {
            var floatSanitizer = _this._sanitizers.filter(function (t) { return t.name == "toFloat"; })[0];
            if (floatSanitizer && _this._baseValue && ReactiveFormConfig.number && ReactiveFormConfig.number.decimalSymbol == ",") {
                var baseValue = String(_this._baseValue);
                if (baseValue.indexOf('.') != -1) {
                    _this._baseValue = baseValue.replace(".", ReactiveFormConfig.number.decimalSymbol);
                    _super.prototype.setValue.call(_this, _this._baseValue);
                }
            }
        }
        return _this;
    }
    Object.defineProperty(RxFormControl.prototype, "errors", {
        get: function () {
            return this._errors;
        },
        set: function (value) {
            this._errors = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RxFormControl.prototype, "errorMessages", {
        get: function () {
            if (!this._messageExpression) {
                if (this._errorMessages.length == 0 && this.errors)
                    this.setControlErrorMessages();
            }
            else if (this._messageExpression && !this._isPassedExpression)
                return [];
            if (!this.errors && this._errorMessages.length > 0)
                this.setControlErrorMessages();
            return this._errorMessages;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RxFormControl.prototype, "errorMessage", {
        get: function () {
            if (!this._messageExpression) {
                if (this._errorMessage == undefined && this.errors)
                    this.setControlErrorMessages();
            }
            else if (this._messageExpression && !this._isPassedExpression)
                return undefined;
            if (!this.errors && this._errorMessage)
                this.setControlErrorMessages();
            return this._errorMessage;
        },
        enumerable: true,
        configurable: true
    });
    RxFormControl.prototype.getFormState = function (value) {
        var baseValue = value;
        if (Array.isArray(value)) {
            baseValue = [];
            value.forEach(function (t) { return baseValue.push(t); });
        }
        return baseValue;
    };
    Object.defineProperty(RxFormControl.prototype, "isModified", {
        get: function () {
            return this._isModified;
        },
        enumerable: true,
        configurable: true
    });
    RxFormControl.prototype.setValue = function (value, options) {
        var parsedValue = this.getSanitizedValue(value);
        if (options && options.dirty)
            this.baseObject[this.keyName] = value;
        this.entityObject[this.keyName] = parsedValue;
        _super.prototype.setValue.call(this, value, options);
        this.bindError();
        this.bindClassName();
        this.executeExpressions();
        this.callPatch();
        if (options && !options.updateChanged && this.root[VALUE_CHANGED_SYNC]) {
            this.root[VALUE_CHANGED_SYNC]();
        }
    };
    RxFormControl.prototype.getControlValue = function () {
        return this.getSanitizedValue(this.value);
    };
    RxFormControl.prototype.bindError = function () {
        if (this._messageExpression)
            this._isPassedExpression = this.executeExpression(this._messageExpression, this);
        this.setControlErrorMessages();
        this.errors = this.errors;
    };
    RxFormControl.prototype.bindClassName = function () {
        if (this.updateOnElementClass && typeof this.updateOnElementClass === "function") {
            var className = this.executeExpression(this._classNameExpression, this);
            var updateElement = this.updateOnElementClass;
            updateElement(className);
        }
    };
    RxFormControl.prototype.markAsTouched = function (opts) {
        var currentState = this.touched;
        _super.prototype.markAsTouched.call(this, opts);
        if (currentState != this.touched)
            this.runControlPropChangeExpression([TOUCHED, UNTOUCHED]);
    };
    RxFormControl.prototype.markAsUntouched = function (opts) {
        var currentState = this.untouched;
        _super.prototype.markAsUntouched.call(this, opts);
        if (currentState != this.untouched)
            this.runControlPropChangeExpression([UNTOUCHED, TOUCHED]);
    };
    RxFormControl.prototype.markAsDirty = function (opts) {
        var currentState = this.dirty;
        _super.prototype.markAsDirty.call(this, opts);
        if (currentState != this.dirty)
            this.runControlPropChangeExpression([DIRTY]);
    };
    RxFormControl.prototype.markAsPristine = function (opts) {
        var currentState = this.pristine;
        _super.prototype.markAsDirty.call(this, opts);
        if (currentState != this.pristine)
            this.runControlPropChangeExpression([PRISTINE]);
    };
    RxFormControl.prototype.markAsPending = function (opts) {
        var currentState = this.pending;
        _super.prototype.markAsDirty.call(this, opts);
        if (currentState != this.pending)
            this.runControlPropChangeExpression([PENDING]);
    };
    RxFormControl.prototype.runControlPropChangeExpression = function (propNames) {
        var _this = this;
        propNames.forEach(function (name) {
            if ((_this._controlProp && _this._messageExpression && _this._controlProp[name]) || (!_this._messageExpression && _this.checkErrorMessageStrategy()))
                _this.bindError();
            if (_this._classNameControlProp && _this._classNameControlProp[name])
                _this.bindClassName();
        });
    };
    RxFormControl.prototype.refresh = function () {
        this.getMessageExpression(this.parent, this.keyName);
        this.bindConditionalControls(DECORATORS.disabled, "_refDisableControls");
        this.bindConditionalControls(DECORATORS.error, "_refMessageControls");
        this.bindConditionalControls(DECORATORS.elementClass, "_refClassNameControls");
        this.executeExpressions();
        this.bindError();
    };
    RxFormControl.prototype.reset = function (value) {
        if (value !== undefined)
            this.setValue(value);
        else
            this.setValue(this.getFormState(this._baseValue));
    };
    RxFormControl.prototype.commit = function () {
        this._baseValue = this.value;
        this.callPatch();
    };
    RxFormControl.prototype.callPatch = function () {
        this._isModified = this.getValue(this._baseValue) != this.getValue(this.value);
        if (this.parent && this.parent[PATCH])
            this.parent[PATCH](this.keyName);
    };
    RxFormControl.prototype.checkErrorMessageStrategy = function () {
        var isBind = true;
        switch (this._errorMessageBindingStrategy) {
            case ErrorMessageBindingStrategy.OnSubmit:
                isBind = this.parent.submitted;
                break;
            case ErrorMessageBindingStrategy.OnDirty:
                isBind = this.dirty;
                break;
            case ErrorMessageBindingStrategy.OnTouched:
                isBind = this.touched;
                break;
            case ErrorMessageBindingStrategy.OnDirtyOrTouched:
                isBind = this.dirty || this.touched;
                break;
            case ErrorMessageBindingStrategy.OnDirtyOrSubmit:
                isBind = this.dirty || this.parent.submitted;
                break;
            case ErrorMessageBindingStrategy.OnTouchedOrSubmit:
                isBind = this.touched || this.parent.submitted;
                break;
            default:
                isBind = true;
        }
        return isBind;
    };
    RxFormControl.prototype.executeExpressions = function () {
        this.processExpression("_refDisableControls", "disabled");
        this.processExpression("_refMessageControls", "bindError");
        this.processExpression("_refClassNameControls", "bindClassName");
    };
    RxFormControl.prototype.getMessageExpression = function (formGroup, keyName) {
        if (formGroup[MODEL_INSTANCE]) {
            var instanceContainer = defaultContainer.get(formGroup[MODEL_INSTANCE].constructor);
            if (instanceContainer) {
                this._messageExpression = instanceContainer.nonValidationDecorators.error.conditionalExpressions[keyName];
                this._controlProp = instanceContainer.nonValidationDecorators.error.controlProp[this.keyName];
                this._classNameExpression = instanceContainer.nonValidationDecorators.elementClass.conditionalExpressions[keyName];
                this._classNameControlProp = instanceContainer.nonValidationDecorators.elementClass.controlProp[keyName];
                if (this._classNameExpression)
                    this.updateOnElementClass = true;
            }
        }
    };
    RxFormControl.prototype.getSanitizedValue = function (value) {
        var e_1, _a;
        if (this._sanitizers) {
            try {
                for (var _b = tslib_1.__values(this._sanitizers), _c = _b.next(); !_c.done; _c = _b.next()) {
                    var sanitizer = _c.value;
                    value = SANITIZERS[sanitizer.name](value, sanitizer.config);
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                }
                finally { if (e_1) throw e_1.error; }
            }
        }
        return value;
    };
    RxFormControl.prototype.bindConditionalControls = function (decoratorType, refName) {
        var _this = this;
        this._disableProvider = new DisableProvider(decoratorType, this.entityObject);
        this[refName] = this._disableProvider.zeroArgumentProcess(this, this.keyName);
        this._disableProvider.oneArgumentProcess(this, "" + this.keyName + RXCODE + "1").forEach(function (t) { return _this[refName].push(t); });
    };
    RxFormControl.prototype.setControlErrorMessages = function () {
        var _this = this;
        if ((!this._messageExpression && this.checkErrorMessageStrategy()) || this._isPassedExpression) {
            this._errorMessages = [];
            if (this.errors) {
                Object.keys(this.errors).forEach(function (t) {
                    if (_this.parent) {
                        _this.parent[CONTROLS_ERROR][_this.keyName] = _this._errorMessage = _this.getErrorMessage(_this.errors, t);
                        if (!_this._errorMessage) {
                            var errorObject = ObjectMaker.toJson(t, undefined, [_this.errors[t][t]]);
                            _this.parent[CONTROLS_ERROR][_this.keyName] = _this._errorMessage = _this.getErrorMessage(errorObject, t);
                        }
                    }
                    else
                        _this._errorMessage = _this.getErrorMessage(_this.errors, t);
                    _this._errorMessages.push(_this._errorMessage);
                });
            }
            else {
                this._errorMessage = undefined;
                if (this.parent) {
                    this.parent[CONTROLS_ERROR][this.keyName] = undefined;
                    delete this.parent[CONTROLS_ERROR][this.keyName];
                }
            }
        }
        else {
            this._errorMessages = [];
            this._errorMessage = undefined;
        }
    };
    RxFormControl.prototype.getErrorMessage = function (errorObject, keyName) {
        if (errorObject[keyName][MESSAGE])
            return errorObject[keyName][MESSAGE];
        return;
    };
    RxFormControl.prototype.processExpression = function (propName, operationType) {
        var e_2, _a;
        if (this[propName])
            try {
                for (var _b = tslib_1.__values(this[propName]), _c = _b.next(); !_c.done; _c = _b.next()) {
                    var controlInfo = _c.value;
                    var control = controlInfo.isRoot ? ApplicationUtil.getControl(controlInfo.controlPath, ApplicationUtil.getRootFormGroup(this)) : ApplicationUtil.getFormControl(controlInfo.controlPath, this);
                    if (control) {
                        if (operationType == "disabled") {
                            var result = this.executeExpression(controlInfo.conditionalExpression, control);
                            if (result)
                                control.disable();
                            else
                                control.enable();
                        }
                        else if (operationType == "bindError")
                            control.bindError();
                        else if (operationType == "bindClassName")
                            control.bindClassName();
                    }
                }
            }
            catch (e_2_1) { e_2 = { error: e_2_1 }; }
            finally {
                try {
                    if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                }
                finally { if (e_2) throw e_2.error; }
            }
    };
    RxFormControl.prototype.executeExpression = function (expression, control) {
        return expression.call(control.parent[MODEL_INSTANCE], control, ApplicationUtil.getParentModelInstanceValue(this), control.parent[MODEL_INSTANCE]);
    };
    RxFormControl.prototype.getValue = function (value) {
        return value !== undefined && value !== null && value !== "" ? value : "";
    };
    return RxFormControl;
}(FormControl));
export { RxFormControl };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS1jb250cm9sLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHJ4d2ViL3JlYWN0aXZlLWZvcm0tdmFsaWRhdG9ycy8iLCJzb3VyY2VzIjpbInNlcnZpY2VzL2Zvcm0tY29udHJvbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUE0QixXQUFXLEVBQWlDLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEcsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxPQUFPLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sVUFBVSxDQUFBO0FBQ3RFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQTtBQUNsRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDN0QsT0FBTyxFQUFFLE1BQU0sRUFBRSxjQUFjLEVBQUUsS0FBSyxFQUFFLE1BQU0sb0JBQW9CLENBQUE7QUFDbEUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzVELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQTtBQUUvQyxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDdkQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFFbEUsSUFBTSxLQUFLLEdBQVUsT0FBTyxDQUFDO0FBQzdCLElBQU0sT0FBTyxHQUFVLFNBQVMsQ0FBQztBQUNqQyxJQUFNLFNBQVMsR0FBVSxXQUFXLENBQUM7QUFDckMsSUFBTSxRQUFRLEdBQVUsVUFBVSxDQUFDO0FBQ25DLElBQU0sT0FBTyxHQUFVLFNBQVMsQ0FBQztBQUVqQztJQUFtQyx5Q0FBVztJQXdEMUMsdUJBQVksU0FBYyxFQUFFLFNBQTZDLEVBQUUsY0FBNEQsRUFBVSxZQUFvQyxFQUFV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SSxVQUFVLEVBQUU7NEJBQzdCLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMscUJBQXFCLEVBQUUsT0FBTyxDQUFDLENBQUM7NEJBQ2hGLElBQUksTUFBTTtnQ0FDTixPQUFPLENBQUMsT0FBTyxFQUFFLENBQUE7O2dDQUVqQixPQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7eUJBQ3hCOzZCQUFNLElBQUksYUFBYSxJQUFJLFdBQVc7NEJBQ25DLE9BQU8sQ0FBQyxTQUFTLEVBQUUsQ0FBQzs2QkFDbkIsSUFBSSxhQUFhLElBQUksZUFBZTs0QkFDckMsT0FBTyxDQUFDLGFBQWEsRUFBRSxDQUFDO3FCQUUvQjtpQkFDSjs7Ozs7Ozs7YUFBQTtJQUNULENBQUM7SUFFTyx5Q0FBaUIsR0FBekIsVUFBMEIsVUFBb0IsRUFBRSxPQUF3QjtRQUNwRSxPQUFPLFVBQVUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsRUFBRSxPQUFPLEVBQUUsZUFBZSxDQUFDLDJCQUEyQixDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQTtJQUN0SixDQUFDO0lBRU8sZ0NBQVEsR0FBaEIsVUFBaUIsS0FBVTtRQUN2QixPQUFPLEtBQUssS0FBSyxTQUFTLElBQUksS0FBSyxLQUFLLElBQUksSUFBSSxLQUFLLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUM5RSxDQUFDO0lBRUwsb0JBQUM7QUFBRCxDQUFDLEFBeFZELENBQW1DLFdBQVcsR0F3VjdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtGb3JtR3JvdXAsIEFic3RyYWN0Q29udHJvbCxGb3JtQ29udHJvbCwgVmFsaWRhdG9yRm4sIEFzeW5jVmFsaWRhdG9yRm4gfSBmcm9tIFwiQGFuZ3VsYXIvZm9ybXNcIjtcclxuaW1wb3J0IHsgT2JqZWN0TWFrZXIgfSBmcm9tIFwiLi4vdXRpbC9vYmplY3QtbWFrZXJcIjtcclxuaW1wb3J0IHsgTUVTU0FHRSwgQ09OVFJPTFNfRVJST1IsIFZBTFVFX0NIQU5HRURfU1lOQyB9IGZyb20gJy4uL2NvbnN0J1xyXG5pbXBvcnQgeyBBcHBsaWNhdGlvblV0aWwgfSBmcm9tICcuLi91dGlsL2FwcC11dGlsJ1xyXG5pbXBvcnQgeyBEaXNhYmxlUHJvdmlkZXIgfSBmcm9tICcuLi9kb21haW4vZGlzYWJsZS1wcm92aWRlcic7XHJcbmltcG9ydCB7IFJYQ09ERSwgTU9ERUxfSU5TVEFOQ0UsIFBBVENIIH0gZnJvbSBcIi4uL2NvbnN0L2FwcC5jb25zdFwiXHJcbmltcG9ydCB7IERFQ09SQVRPUlMgfSBmcm9tIFwiLi4vY29uc3QvZGVjb3JhdG9ycy5jb25zdFwiO1xyXG5pbXBvcnQgeyBkZWZhdWx0Q29udGFpbmVyIH0gZnJvbSBcIi4uL2NvcmUvZGVmYXVsdENvbnRhaW5lclwiO1xyXG5pbXBvcnQgeyBTQU5JVElaRVJTIH0gZnJvbSBcIi4uL3V0aWwvc2FuaXRpemVyc1wiXHJcbmltcG9ydCB7IERhdGFTYW5pdGl6ZXIgfSBmcm9tICcuLi9jb3JlL3ZhbGlkYXRvci5pbnRlcmZhY2UnXHJcbmltcG9ydCB7IEVycm9yTWVzc2FnZUJpbmRpbmdTdHJhdGVneSB9IGZyb20gXCIuLi9lbnVtc1wiO1xyXG5pbXBvcnQgeyBSZWFjdGl2ZUZvcm1Db25maWcgfSBmcm9tIFwiLi4vdXRpbC9yZWFjdGl2ZS1mb3JtLWNvbmZpZ1wiO1xyXG5cclxuY29uc3QgRElSVFk6c3RyaW5nID0gXCJkaXJ0eVwiO1xyXG5jb25zdCBUT1VDSEVEOnN0cmluZyA9IFwidG91Y2hlZFwiO1xyXG5jb25zdCBVTlRPVUNIRUQ6c3RyaW5nID0gXCJ1bnRvdWNoZWRcIjtcclxuY29uc3QgUFJJU1RJTkU6c3RyaW5nID0gXCJwcmlzdGluZVwiO1xyXG5jb25zdCBQRU5ESU5HOnN0cmluZyA9IFwicGVuZGluZ1wiO1xyXG5cclxuZXhwb3J0IGNsYXNzIFJ4Rm9ybUNvbnRyb2wgZXh0ZW5kcyBGb3JtQ29udHJvbCB7XHJcbiAgICBwcml2YXRlIGtleU5hbWU6IHN0cmluZztcclxuICAgIHByaXZhdGUgX2Vycm9yTWVzc2FnZTogc3RyaW5nO1xyXG4gICAgcHJpdmF0ZSBfZXJyb3JNZXNzYWdlczogc3RyaW5nW10gPSBbXTtcclxuICAgIHByaXZhdGUgX2Rpc2FibGVQcm92aWRlcjogRGlzYWJsZVByb3ZpZGVyO1xyXG4gICAgcHJpdmF0ZSBfY29sdW1uczogc3RyaW5nW107XHJcbiAgICBwcml2YXRlIF9jaGlsZENvbHVtbnM6IGFueSA9IFtdO1xyXG4gICAgcHJpdmF0ZSBfcGFyZW50Q29sdW1uczogeyBba2V5OiBzdHJpbmddOiBzdHJpbmdbXSB9O1xyXG4gICAgcHJpdmF0ZSBfcmVmRGlzYWJsZUNvbnRyb2xzPSBbXTtcclxuICAgIHByaXZhdGUgX3JlZk1lc3NhZ2VDb250cm9scyA9IFtdO1xyXG4gICAgcHJpdmF0ZSBfcmVmQ2xhc3NOYW1lQ29udHJvbHMgPSBbXTtcclxuICAgIHByaXZhdGUgX2Vycm9yTWVzc2FnZUJpbmRpbmdTdHJhdGVneTogRXJyb3JNZXNzYWdlQmluZGluZ1N0cmF0ZWd5O1xyXG4gICAgcHJpdmF0ZSBfbWVzc2FnZUV4cHJlc3Npb246IEZ1bmN0aW9uO1xyXG4gICAgcHJpdmF0ZSBfY2xhc3NOYW1lRXhwcmVzc2lvbjogRnVuY3Rpb247XHJcbiAgICBwcml2YXRlIF9pc1Bhc3NlZEV4cHJlc3Npb246IEJvb2xlYW4gPSBmYWxzZTtcclxuICAgIHByaXZhdGUgX2NvbnRyb2xQcm9wOiB7IFtrZXk6IHN0cmluZ106IGJvb2xlYW4gfTtcclxuICAgIHByaXZhdGUgX2NsYXNzTmFtZUNvbnRyb2xQcm9wOiB7IFtrZXk6IHN0cmluZ106IGJvb2xlYW4gfTtcclxuICAgIHByaXZhdGUgX2Jhc2VWYWx1ZTogYW55O1xyXG4gICAgcHJpdmF0ZSBfaXNNb2RpZmllZDogYm9vbGVhbjtcclxuICAgIHByaXZhdGUgX2Vycm9yczogYW55O1xyXG4gICAgdXBkYXRlT25FbGVtZW50Q2xhc3M6IGJvb2xlYW4gfCBGdW5jdGlvbjtcclxuICAgIHByZUhvb2s6IEZ1bmN0aW9uO1xyXG4gICAgcG9zdEhvb2s6IEZ1bmN0aW9uO1xyXG5cclxuICAgIGdldCBlcnJvcnMoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2Vycm9ycztcclxuICAgIH1cclxuXHJcbiAgICBzZXQgZXJyb3JzKHZhbHVlOiBhbnkpIHtcclxuICAgICAgICB0aGlzLl9lcnJvcnMgPSB2YWx1ZTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgZ2V0IGVycm9yTWVzc2FnZXMoKTogc3RyaW5nW10ge1xyXG4gICAgICAgIGlmICghdGhpcy5fbWVzc2FnZUV4cHJlc3Npb24pIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuX2Vycm9yTWVzc2FnZXMubGVuZ3RoID09IDAgJiYgdGhpcy5lcnJvcnMpXHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldENvbnRyb2xFcnJvck1lc3NhZ2VzKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYodGhpcy5fbWVzc2FnZUV4cHJlc3Npb24gJiYgIXRoaXMuX2lzUGFzc2VkRXhwcmVzc2lvbilcclxuICAgICAgICAgICAgcmV0dXJuIFtdO1xyXG4gICAgICAgIGlmICghdGhpcy5lcnJvcnMgJiYgdGhpcy5fZXJyb3JNZXNzYWdlcy5sZW5ndGggPiAwKVxyXG4gICAgICAgICAgICB0aGlzLnNldENvbnRyb2xFcnJvck1lc3NhZ2VzKCk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2Vycm9yTWVzc2FnZXM7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGVycm9yTWVzc2FnZSgpOiBzdHJpbmcge1xyXG4gICAgICAgIGlmICghdGhpcy5fbWVzc2FnZUV4cHJlc3Npb24pIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuX2Vycm9yTWVzc2FnZSA9PSB1bmRlZmluZWQgJiYgdGhpcy5lcnJvcnMpXHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldENvbnRyb2xFcnJvck1lc3NhZ2VzKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYodGhpcy5fbWVzc2FnZUV4cHJlc3Npb24gJiYgIXRoaXMuX2lzUGFzc2VkRXhwcmVzc2lvbilcclxuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgICBpZiAoIXRoaXMuZXJyb3JzICYmIHRoaXMuX2Vycm9yTWVzc2FnZSlcclxuICAgICAgICAgICAgdGhpcy5zZXRDb250cm9sRXJyb3JNZXNzYWdlcygpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9lcnJvck1lc3NhZ2U7XHJcbiAgICB9XHJcbiAgICBjb25zdHJ1Y3Rvcihmb3JtU3RhdGU6IGFueSwgdmFsaWRhdG9yOiBWYWxpZGF0b3JGbiB8IFZhbGlkYXRvckZuW10gfCBudWxsLCBhc3luY1ZhbGlkYXRvcjogQXN5bmNWYWxpZGF0b3JGbiB8IEFzeW5jVmFsaWRhdG9yRm5bXSB8IG51bGwsIHByaXZhdGUgZW50aXR5T2JqZWN0OiB7IFtrZXk6IHN0cmluZ106IGFueSB9LCBwcml2YXRlIGJhc2VPYmplY3Q6IHsgW2tleTogc3RyaW5nXTogYW55IH0sIGNvbnRyb2xOYW1lOiBzdHJpbmcsIHByaXZhdGUgX3Nhbml0aXplcnM6IERhdGFTYW5pdGl6ZXJbXSkge1xyXG4gICAgICAgIHN1cGVyKGZvcm1TdGF0ZSwgdmFsaWRhdG9yLCBhc3luY1ZhbGlkYXRvcilcclxuICAgICAgICB0aGlzLl9iYXNlVmFsdWUgPSBmb3JtU3RhdGUgPT09IHVuZGVmaW5lZCA/IG51bGwgOiB0aGlzLmdldEZvcm1TdGF0ZShmb3JtU3RhdGUpO1xyXG4gICAgICAgIHRoaXMuX2lzTW9kaWZpZWQgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLmtleU5hbWUgPSBjb250cm9sTmFtZTtcclxuICAgICAgICB0aGlzLl9lcnJvck1lc3NhZ2VCaW5kaW5nU3RyYXRlZ3kgPSBSZWFjdGl2ZUZvcm1Db25maWcuZ2V0KFwicmVhY3RpdmVGb3JtLmVycm9yTWVzc2FnZUJpbmRpbmdTdHJhdGVneVwiKSBhcyBFcnJvck1lc3NhZ2VCaW5kaW5nU3RyYXRlZ3k7XHJcbiAgICAgICAgaWYgKHRoaXMuX3Nhbml0aXplcnMpIHtcclxuICAgICAgICAgICAgdmFyIGZsb2F0U2FuaXRpemVyID0gdGhpcy5fc2FuaXRpemVycy5maWx0ZXIodCA9PiB0Lm5hbWUgPT0gXCJ0b0Zsb2F0XCIpWzBdXHJcbiAgICAgICAgICAgIGlmIChmbG9hdFNhbml0aXplciAmJiB0aGlzLl9iYXNlVmFsdWUgJiYgUmVhY3RpdmVGb3JtQ29uZmlnLm51bWJlciAmJiBSZWFjdGl2ZUZvcm1Db25maWcubnVtYmVyLmRlY2ltYWxTeW1ib2wgPT0gXCIsXCIpIHtcclxuICAgICAgICAgICAgICAgIGxldCBiYXNlVmFsdWUgPSBTdHJpbmcodGhpcy5fYmFzZVZhbHVlKTtcclxuICAgICAgICAgICAgICAgIGlmIChiYXNlVmFsdWUuaW5kZXhPZignLicpICE9IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYmFzZVZhbHVlID0gYmFzZVZhbHVlLnJlcGxhY2UoXCIuXCIsIFJlYWN0aXZlRm9ybUNvbmZpZy5udW1iZXIuZGVjaW1hbFN5bWJvbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgc3VwZXIuc2V0VmFsdWUodGhpcy5fYmFzZVZhbHVlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0Rm9ybVN0YXRlKHZhbHVlKSB7XHJcbiAgICAgICAgbGV0IGJhc2VWYWx1ZSA9IHZhbHVlXHJcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XHJcbiAgICAgICAgICAgIGJhc2VWYWx1ZSA9IFtdO1xyXG4gICAgICAgICAgICB2YWx1ZS5mb3JFYWNoKHQgPT4gYmFzZVZhbHVlLnB1c2godCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gYmFzZVZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBpc01vZGlmaWVkKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9pc01vZGlmaWVkO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFZhbHVlKHZhbHVlOiBhbnksIG9wdGlvbnM/OiB7XHJcbiAgICAgICAgZGlydHk/OiBib29sZWFuO1xyXG4gICAgICAgIHVwZGF0ZUNoYW5nZWQ/OiBib29sZWFuO1xyXG4gICAgICAgIG9ubHlTZWxmPzogYm9vbGVhbjtcclxuICAgICAgICBlbWl0RXZlbnQ/OiBib29sZWFuO1xyXG4gICAgICAgIGlzVGhyb3VnaER5bmFtaWM/OiBib29sZWFuO1xyXG4gICAgfSk6IHZvaWQge1xyXG4gICAgICAgICAgICBsZXQgcGFyc2VkVmFsdWUgPSB0aGlzLmdldFNhbml0aXplZFZhbHVlKHZhbHVlKVxyXG4gICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmRpcnR5KVxyXG4gICAgICAgICAgICAgICAgdGhpcy5iYXNlT2JqZWN0W3RoaXMua2V5TmFtZV0gPSB2YWx1ZTtcclxuICAgICAgICAgICAgdGhpcy5lbnRpdHlPYmplY3RbdGhpcy5rZXlOYW1lXSA9IHBhcnNlZFZhbHVlO1xyXG4gICAgICAgICAgICBzdXBlci5zZXRWYWx1ZSh2YWx1ZSwgb3B0aW9ucyk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB0aGlzLmJpbmRFcnJvcigpO1xyXG4gICAgICAgICAgICB0aGlzLmJpbmRDbGFzc05hbWUoKTtcclxuICAgICAgICAgICAgdGhpcy5leGVjdXRlRXhwcmVzc2lvbnMoKTtcclxuICAgICAgICAgICAgdGhpcy5jYWxsUGF0Y2goKTtcclxuICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgIW9wdGlvbnMudXBkYXRlQ2hhbmdlZCAmJiB0aGlzLnJvb3RbVkFMVUVfQ0hBTkdFRF9TWU5DXSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yb290W1ZBTFVFX0NIQU5HRURfU1lOQ10oKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldENvbnRyb2xWYWx1ZSgpe1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdldFNhbml0aXplZFZhbHVlKHRoaXMudmFsdWUpO1xyXG4gICAgfVxyXG5cclxuICAgIGJpbmRFcnJvcigpIHtcclxuICAgICAgICBpZih0aGlzLl9tZXNzYWdlRXhwcmVzc2lvbilcclxuICAgICAgICAgICAgdGhpcy5faXNQYXNzZWRFeHByZXNzaW9uID0gdGhpcy5leGVjdXRlRXhwcmVzc2lvbih0aGlzLl9tZXNzYWdlRXhwcmVzc2lvbix0aGlzKTtcclxuICAgICAgICB0aGlzLnNldENvbnRyb2xFcnJvck1lc3NhZ2VzKCk7XHJcbiAgICAgICAgdGhpcy5lcnJvcnMgPSB0aGlzLmVycm9ycztcclxuICAgIH1cclxuXHJcbiAgICBiaW5kQ2xhc3NOYW1lKCkge1xyXG4gICAgICAgIGlmICh0aGlzLnVwZGF0ZU9uRWxlbWVudENsYXNzICYmIHR5cGVvZiB0aGlzLnVwZGF0ZU9uRWxlbWVudENsYXNzID09PSBcImZ1bmN0aW9uXCIpIHtcclxuICAgICAgICAgICAgbGV0IGNsYXNzTmFtZSA9IHRoaXMuZXhlY3V0ZUV4cHJlc3Npb24odGhpcy5fY2xhc3NOYW1lRXhwcmVzc2lvbiwgdGhpcyk7XHJcbiAgICAgICAgICAgIGxldCB1cGRhdGVFbGVtZW50ID0gdGhpcy51cGRhdGVPbkVsZW1lbnRDbGFzcyBhcyBGdW5jdGlvbjtcclxuICAgICAgICAgICAgdXBkYXRlRWxlbWVudChjbGFzc05hbWUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG5cclxuXHJcbiAgICBtYXJrQXNUb3VjaGVkKG9wdHM/OiB7XHJcbiAgICAgICAgb25seVNlbGY/OiBib29sZWFuO1xyXG4gICAgfSk6IHZvaWR7XHJcbiAgICAgICAgbGV0IGN1cnJlbnRTdGF0ZSA9IHRoaXMudG91Y2hlZDtcclxuICAgICAgICBzdXBlci5tYXJrQXNUb3VjaGVkKG9wdHMpO1xyXG4gICAgICAgIGlmKGN1cnJlbnRTdGF0ZSAhPSB0aGlzLnRvdWNoZWQpXHJcbiAgICAgICAgICAgIHRoaXMucnVuQ29udHJvbFByb3BDaGFuZ2VFeHByZXNzaW9uKFtUT1VDSEVELFVOVE9VQ0hFRF0pXHJcbiAgICAgICAgXHJcbiAgICB9XHJcblxyXG4gICAgbWFya0FzVW50b3VjaGVkKG9wdHM/OiB7XHJcbiAgICAgICAgb25seVNlbGY/OiBib29sZWFuO1xyXG4gICAgfSk6IHZvaWR7XHJcbiAgICAgICAgbGV0IGN1cnJlbnRTdGF0ZSA9IHRoaXMudW50b3VjaGVkO1xyXG4gICAgICAgIHN1cGVyLm1hcmtBc1VudG91Y2hlZChvcHRzKTtcclxuICAgICAgICBpZihjdXJyZW50U3RhdGUgIT0gdGhpcy51bnRvdWNoZWQpXHJcbiAgICAgICAgICAgIHRoaXMucnVuQ29udHJvbFByb3BDaGFuZ2VFeHByZXNzaW9uKFtVTlRPVUNIRUQsVE9VQ0hFRF0pXHJcbiAgICB9XHJcblxyXG4gICAgbWFya0FzRGlydHkob3B0cz86IHtcclxuICAgICAgICBvbmx5U2VsZj86IGJvb2xlYW47XHJcbiAgICB9KTogdm9pZHtcclxuICAgICAgICBsZXQgY3VycmVudFN0YXRlID0gdGhpcy5kaXJ0eTtcclxuICAgICAgICBzdXBlci5tYXJrQXNEaXJ0eShvcHRzKTtcclxuICAgICAgICBpZihjdXJyZW50U3RhdGUgIT0gdGhpcy5kaXJ0eSlcclxuICAgICAgICAgICAgdGhpcy5ydW5Db250cm9sUHJvcENoYW5nZUV4cHJlc3Npb24oW0RJUlRZXSlcclxuICAgIH1cclxuXHJcbiAgICBtYXJrQXNQcmlzdGluZShvcHRzPzoge1xyXG4gICAgICAgIG9ubHlTZWxmPzogYm9vbGVhbjtcclxuICAgIH0pOiB2b2lke1xyXG4gICAgICAgIGxldCBjdXJyZW50U3RhdGUgPSB0aGlzLnByaXN0aW5lO1xyXG4gICAgICAgIHN1cGVyLm1hcmtBc0RpcnR5KG9wdHMpO1xyXG4gICAgICAgIGlmKGN1cnJlbnRTdGF0ZSAhPSB0aGlzLnByaXN0aW5lKVxyXG4gICAgICAgICAgICB0aGlzLnJ1bkNvbnRyb2xQcm9wQ2hhbmdlRXhwcmVzc2lvbihbUFJJU1RJTkVdKVxyXG4gICAgfVxyXG5cclxuICAgIG1hcmtBc1BlbmRpbmcob3B0cz86IHtcclxuICAgICAgICBvbmx5U2VsZj86IGJvb2xlYW47XHJcbiAgICAgICAgZW1pdEV2ZW50PzogYm9vbGVhbjtcclxuICAgIH0pOiB2b2lke1xyXG4gICAgICAgIGxldCBjdXJyZW50U3RhdGUgPSB0aGlzLnBlbmRpbmc7XHJcbiAgICAgICAgc3VwZXIubWFya0FzRGlydHkob3B0cyk7XHJcbiAgICAgICAgaWYoY3VycmVudFN0YXRlICE9IHRoaXMucGVuZGluZylcclxuICAgICAgICAgICAgdGhpcy5ydW5Db250cm9sUHJvcENoYW5nZUV4cHJlc3Npb24oW1BFTkRJTkddKVxyXG4gICAgfVxyXG5cclxuICAgIHJ1bkNvbnRyb2xQcm9wQ2hhbmdlRXhwcmVzc2lvbihwcm9wTmFtZXM6c3RyaW5nW10pe1xyXG4gICAgICAgIHByb3BOYW1lcy5mb3JFYWNoKG5hbWUgPT4ge1xyXG4gICAgICAgICAgICBpZiAoKHRoaXMuX2NvbnRyb2xQcm9wICYmIHRoaXMuX21lc3NhZ2VFeHByZXNzaW9uICYmIHRoaXMuX2NvbnRyb2xQcm9wW25hbWVdKSB8fCAoIXRoaXMuX21lc3NhZ2VFeHByZXNzaW9uICYmIHRoaXMuY2hlY2tFcnJvck1lc3NhZ2VTdHJhdGVneSgpKSlcclxuICAgICAgICAgICAgICAgIHRoaXMuYmluZEVycm9yKCk7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLl9jbGFzc05hbWVDb250cm9sUHJvcCAmJiB0aGlzLl9jbGFzc05hbWVDb250cm9sUHJvcFtuYW1lXSlcclxuICAgICAgICAgICAgICAgIHRoaXMuYmluZENsYXNzTmFtZSgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHJlZnJlc2goKSB7XHJcbiAgICAgICAgdGhpcy5nZXRNZXNzYWdlRXhwcmVzc2lvbig8Rm9ybUdyb3VwPnRoaXMucGFyZW50LHRoaXMua2V5TmFtZSk7XHJcbiAgICAgICAgdGhpcy5iaW5kQ29uZGl0aW9uYWxDb250cm9scyhERUNPUkFUT1JTLmRpc2FibGVkLFwiX3JlZkRpc2FibGVDb250cm9sc1wiKTtcclxuICAgICAgICB0aGlzLmJpbmRDb25kaXRpb25hbENvbnRyb2xzKERFQ09SQVRPUlMuZXJyb3IsIFwiX3JlZk1lc3NhZ2VDb250cm9sc1wiKTtcclxuICAgICAgICB0aGlzLmJpbmRDb25kaXRpb25hbENvbnRyb2xzKERFQ09SQVRPUlMuZWxlbWVudENsYXNzLCBcIl9yZWZDbGFzc05hbWVDb250cm9sc1wiKTtcclxuICAgICAgICB0aGlzLmV4ZWN1dGVFeHByZXNzaW9ucygpO1xyXG4gICAgICAgIHRoaXMuYmluZEVycm9yKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVzZXQodmFsdWU/OiBhbnkpIHtcclxuICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZClcclxuICAgICAgICAgICAgdGhpcy5zZXRWYWx1ZSh2YWx1ZSk7XHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICB0aGlzLnNldFZhbHVlKHRoaXMuZ2V0Rm9ybVN0YXRlKHRoaXMuX2Jhc2VWYWx1ZSkpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbW1pdCgpIHtcclxuICAgICAgICB0aGlzLl9iYXNlVmFsdWUgPSB0aGlzLnZhbHVlO1xyXG4gICAgICAgIHRoaXMuY2FsbFBhdGNoKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjYWxsUGF0Y2goKSB7XHJcbiAgICAgICAgdGhpcy5faXNNb2RpZmllZCA9IHRoaXMuZ2V0VmFsdWUodGhpcy5fYmFzZVZhbHVlKSAhPSB0aGlzLmdldFZhbHVlKHRoaXMudmFsdWUpO1xyXG4gICAgICAgIGlmICh0aGlzLnBhcmVudCAmJiB0aGlzLnBhcmVudFtQQVRDSF0pXHJcbiAgICAgICAgICAgIHRoaXMucGFyZW50W1BBVENIXSh0aGlzLmtleU5hbWUpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2hlY2tFcnJvck1lc3NhZ2VTdHJhdGVneSgpIHtcclxuICAgICAgICBsZXQgaXNCaW5kOiBib29sZWFuID0gdHJ1ZTtcclxuICAgICAgICBzd2l0Y2ggKHRoaXMuX2Vycm9yTWVzc2FnZUJpbmRpbmdTdHJhdGVneSkge1xyXG4gICAgICAgICAgICBjYXNlIEVycm9yTWVzc2FnZUJpbmRpbmdTdHJhdGVneS5PblN1Ym1pdDpcclxuICAgICAgICAgICAgICAgIGlzQmluZCA9ICg8YW55PnRoaXMucGFyZW50KS5zdWJtaXR0ZWQ7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBFcnJvck1lc3NhZ2VCaW5kaW5nU3RyYXRlZ3kuT25EaXJ0eTpcclxuICAgICAgICAgICAgICAgIGlzQmluZCA9IHRoaXMuZGlydHk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBFcnJvck1lc3NhZ2VCaW5kaW5nU3RyYXRlZ3kuT25Ub3VjaGVkOlxyXG4gICAgICAgICAgICAgICAgaXNCaW5kID0gdGhpcy50b3VjaGVkO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgRXJyb3JNZXNzYWdlQmluZGluZ1N0cmF0ZWd5Lk9uRGlydHlPclRvdWNoZWQ6XHJcbiAgICAgICAgICAgICAgICBpc0JpbmQgPSB0aGlzLmRpcnR5IHx8IHRoaXMudG91Y2hlZDtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIEVycm9yTWVzc2FnZUJpbmRpbmdTdHJhdGVneS5PbkRpcnR5T3JTdWJtaXQ6XHJcbiAgICAgICAgICAgICAgICBpc0JpbmQgPSB0aGlzLmRpcnR5IHx8ICg8YW55PnRoaXMucGFyZW50KS5zdWJtaXR0ZWQ7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBFcnJvck1lc3NhZ2VCaW5kaW5nU3RyYXRlZ3kuT25Ub3VjaGVkT3JTdWJtaXQ6XHJcbiAgICAgICAgICAgICAgICBpc0JpbmQgPSB0aGlzLnRvdWNoZWQgfHwgKDxhbnk+dGhpcy5wYXJlbnQpLnN1Ym1pdHRlZDtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgaXNCaW5kID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGlzQmluZDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGV4ZWN1dGVFeHByZXNzaW9ucygpe1xyXG4gICAgICAgIHRoaXMucHJvY2Vzc0V4cHJlc3Npb24oXCJfcmVmRGlzYWJsZUNvbnRyb2xzXCIsXCJkaXNhYmxlZFwiKTtcclxuICAgICAgICB0aGlzLnByb2Nlc3NFeHByZXNzaW9uKFwiX3JlZk1lc3NhZ2VDb250cm9sc1wiLCBcImJpbmRFcnJvclwiKTtcclxuICAgICAgICB0aGlzLnByb2Nlc3NFeHByZXNzaW9uKFwiX3JlZkNsYXNzTmFtZUNvbnRyb2xzXCIsIFwiYmluZENsYXNzTmFtZVwiKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldE1lc3NhZ2VFeHByZXNzaW9uKGZvcm1Hcm91cDogRm9ybUdyb3VwLCBrZXlOYW1lOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgICAgICBpZiAoZm9ybUdyb3VwW01PREVMX0lOU1RBTkNFXSkge1xyXG4gICAgICAgICAgICBsZXQgaW5zdGFuY2VDb250YWluZXIgPSBkZWZhdWx0Q29udGFpbmVyLmdldChmb3JtR3JvdXBbTU9ERUxfSU5TVEFOQ0VdLmNvbnN0cnVjdG9yKTtcclxuICAgICAgICAgICAgaWYoaW5zdGFuY2VDb250YWluZXIpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX21lc3NhZ2VFeHByZXNzaW9uID0gaW5zdGFuY2VDb250YWluZXIubm9uVmFsaWRhdGlvbkRlY29yYXRvcnMuZXJyb3IuY29uZGl0aW9uYWxFeHByZXNzaW9uc1trZXlOYW1lXVxyXG4gICAgICAgICAgICAgICAgdGhpcy5fY29udHJvbFByb3AgPSBpbnN0YW5jZUNvbnRhaW5lci5ub25WYWxpZGF0aW9uRGVjb3JhdG9ycy5lcnJvci5jb250cm9sUHJvcFt0aGlzLmtleU5hbWVdO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fY2xhc3NOYW1lRXhwcmVzc2lvbiA9IGluc3RhbmNlQ29udGFpbmVyLm5vblZhbGlkYXRpb25EZWNvcmF0b3JzLmVsZW1lbnRDbGFzcy5jb25kaXRpb25hbEV4cHJlc3Npb25zW2tleU5hbWVdO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fY2xhc3NOYW1lQ29udHJvbFByb3AgPSBpbnN0YW5jZUNvbnRhaW5lci5ub25WYWxpZGF0aW9uRGVjb3JhdG9ycy5lbGVtZW50Q2xhc3MuY29udHJvbFByb3Bba2V5TmFtZV07XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5fY2xhc3NOYW1lRXhwcmVzc2lvbilcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZU9uRWxlbWVudENsYXNzID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRTYW5pdGl6ZWRWYWx1ZSh2YWx1ZTphbnkpIHtcclxuICAgICAgICBpZiAodGhpcy5fc2FuaXRpemVycykge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBzYW5pdGl6ZXIgb2YgdGhpcy5fc2FuaXRpemVycykge1xyXG4gICAgICAgICAgICAgICAgdmFsdWUgPSBTQU5JVElaRVJTW3Nhbml0aXplci5uYW1lXSh2YWx1ZSxzYW5pdGl6ZXIuY29uZmlnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBiaW5kQ29uZGl0aW9uYWxDb250cm9scyhkZWNvcmF0b3JUeXBlOnN0cmluZyxyZWZOYW1lOnN0cmluZyl7XHJcbiAgICAgICAgdGhpcy5fZGlzYWJsZVByb3ZpZGVyID0gbmV3IERpc2FibGVQcm92aWRlcihkZWNvcmF0b3JUeXBlLHRoaXMuZW50aXR5T2JqZWN0KTtcclxuICAgICAgICB0aGlzW3JlZk5hbWVdID0gdGhpcy5fZGlzYWJsZVByb3ZpZGVyLnplcm9Bcmd1bWVudFByb2Nlc3ModGhpcyx0aGlzLmtleU5hbWUpXHJcbiAgICAgICAgdGhpcy5fZGlzYWJsZVByb3ZpZGVyLm9uZUFyZ3VtZW50UHJvY2Vzcyh0aGlzLGAke3RoaXMua2V5TmFtZX0ke1JYQ09ERX0xYCkuZm9yRWFjaCh0PT50aGlzW3JlZk5hbWVdLnB1c2godCkpXHJcblxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2V0Q29udHJvbEVycm9yTWVzc2FnZXMoKSB7XHJcbiAgICAgICAgaWYgKCghdGhpcy5fbWVzc2FnZUV4cHJlc3Npb24gJiYgdGhpcy5jaGVja0Vycm9yTWVzc2FnZVN0cmF0ZWd5KCkpIHx8IHRoaXMuX2lzUGFzc2VkRXhwcmVzc2lvbikge1xyXG4gICAgICAgICAgICB0aGlzLl9lcnJvck1lc3NhZ2VzID0gW107XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmVycm9ycykge1xyXG4gICAgICAgICAgICAgICAgT2JqZWN0LmtleXModGhpcy5lcnJvcnMpLmZvckVhY2godCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucGFyZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFyZW50W0NPTlRST0xTX0VSUk9SXVt0aGlzLmtleU5hbWVdID0gdGhpcy5fZXJyb3JNZXNzYWdlID0gdGhpcy5nZXRFcnJvck1lc3NhZ2UodGhpcy5lcnJvcnMsIHQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2Vycm9yTWVzc2FnZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGVycm9yT2JqZWN0ID0gT2JqZWN0TWFrZXIudG9Kc29uKHQsIHVuZGVmaW5lZCwgW3RoaXMuZXJyb3JzW3RdW3RdXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcmVudFtDT05UUk9MU19FUlJPUl1bdGhpcy5rZXlOYW1lXSA9IHRoaXMuX2Vycm9yTWVzc2FnZSA9IHRoaXMuZ2V0RXJyb3JNZXNzYWdlKGVycm9yT2JqZWN0LCB0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9lcnJvck1lc3NhZ2UgPSB0aGlzLmdldEVycm9yTWVzc2FnZSh0aGlzLmVycm9ycywgdClcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9lcnJvck1lc3NhZ2VzLnB1c2godGhpcy5fZXJyb3JNZXNzYWdlKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9lcnJvck1lc3NhZ2UgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXJlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcmVudFtDT05UUk9MU19FUlJPUl1bdGhpcy5rZXlOYW1lXSA9IHVuZGVmaW5lZFxyXG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnBhcmVudFtDT05UUk9MU19FUlJPUl1bdGhpcy5rZXlOYW1lXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2Vycm9yTWVzc2FnZXMgPSBbXTtcclxuICAgICAgICAgICAgdGhpcy5fZXJyb3JNZXNzYWdlID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRFcnJvck1lc3NhZ2UoZXJyb3JPYmplY3Q6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0sIGtleU5hbWU6IHN0cmluZykge1xyXG4gICAgICAgIGlmIChlcnJvck9iamVjdFtrZXlOYW1lXVtNRVNTQUdFXSlcclxuICAgICAgICAgICAgcmV0dXJuIGVycm9yT2JqZWN0W2tleU5hbWVdW01FU1NBR0VdO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcblxyXG5cclxuICAgIHByaXZhdGUgcHJvY2Vzc0V4cHJlc3Npb24ocHJvcE5hbWU6IHN0cmluZywgb3BlcmF0aW9uVHlwZTogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYodGhpc1twcm9wTmFtZV0pXHJcbiAgICAgICAgICAgIGZvcih2YXIgY29udHJvbEluZm8gb2YgdGhpc1twcm9wTmFtZV0pe1xyXG4gICAgICAgICAgICAgICAgbGV0IGNvbnRyb2wgPSBjb250cm9sSW5mby5pc1Jvb3QgP0FwcGxpY2F0aW9uVXRpbC5nZXRDb250cm9sKGNvbnRyb2xJbmZvLmNvbnRyb2xQYXRoLEFwcGxpY2F0aW9uVXRpbC5nZXRSb290Rm9ybUdyb3VwKHRoaXMpKSA6IEFwcGxpY2F0aW9uVXRpbC5nZXRGb3JtQ29udHJvbChjb250cm9sSW5mby5jb250cm9sUGF0aCx0aGlzKTtcclxuICAgICAgICAgICAgICAgIGlmKGNvbnRyb2wpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAob3BlcmF0aW9uVHlwZSA9PSBcImRpc2FibGVkXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJlc3VsdCA9IHRoaXMuZXhlY3V0ZUV4cHJlc3Npb24oY29udHJvbEluZm8uY29uZGl0aW9uYWxFeHByZXNzaW9uLCBjb250cm9sKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdClcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2wuZGlzYWJsZSgpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2wuZW5hYmxlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRpb25UeXBlID09IFwiYmluZEVycm9yXCIpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2wuYmluZEVycm9yKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAob3BlcmF0aW9uVHlwZSA9PSBcImJpbmRDbGFzc05hbWVcIilcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbC5iaW5kQ2xhc3NOYW1lKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBleGVjdXRlRXhwcmVzc2lvbihleHByZXNzaW9uOiBGdW5jdGlvbiwgY29udHJvbDogQWJzdHJhY3RDb250cm9sKTogQm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIGV4cHJlc3Npb24uY2FsbChjb250cm9sLnBhcmVudFtNT0RFTF9JTlNUQU5DRV0sIGNvbnRyb2wsIEFwcGxpY2F0aW9uVXRpbC5nZXRQYXJlbnRNb2RlbEluc3RhbmNlVmFsdWUodGhpcyksIGNvbnRyb2wucGFyZW50W01PREVMX0lOU1RBTkNFXSlcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldFZhbHVlKHZhbHVlOiBhbnkpIHtcclxuICAgICAgICByZXR1cm4gdmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gXCJcIiA/IHZhbHVlIDogXCJcIjtcclxuICAgIH1cclxuXHJcbn1cclxuIl19