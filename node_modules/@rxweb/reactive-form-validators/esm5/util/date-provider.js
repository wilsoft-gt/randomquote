import * as tslib_1 from "tslib";
import { ReactiveFormConfig } from "./reactive-form-config";
import { ApplicationUtil } from './app-util';
var ISO_DATE_REGEX = /^(\d{4}-\d{1,2}-\d{1,2})$/;
var DateProvider = /** @class */ (function () {
    function DateProvider() {
    }
    DateProvider.prototype.isDate = function (value) {
        return value instanceof Date && !isNaN(value.valueOf());
    };
    DateProvider.prototype.getRegex = function (dateFormat) {
        var regExp;
        switch (dateFormat) {
            case 'ymd':
                regExp = "^(?:[0-9]{4})-(1[0-2]|0?[1-9])-(3[01]|[12][0-9]|0?[1-9])$";
                break;
            case 'dmy':
                regExp = "^(3[01]|[12][0-9]|0?[1-9])-(1[0-2]|0?[1-9])-(?:[0-9]{2})?[0-9]{2}$";
                break;
            case 'mdy':
                regExp = "^(1[0-2]|0?[1-9])-(3[01]|[12][0-9]|0?[1-9])-(?:[0-9]{2})?[0-9]{2}$";
                break;
        }
        return new RegExp(regExp);
    };
    DateProvider.prototype.regex = function () {
        var regExp;
        if (ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.internationalization && ReactiveFormConfig.json.internationalization.dateFormat && ReactiveFormConfig.json.internationalization.seperator)
            regExp = this.getRegex(ReactiveFormConfig.json.internationalization.dateFormat);
        else
            regExp = (ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.baseConfig && ReactiveFormConfig.json.baseConfig.dateFormat) ? this.getRegex(ReactiveFormConfig.json.baseConfig.dateFormat) : this.getRegex("mdy");
        return regExp;
    };
    DateProvider.prototype.getDate = function (value, isBaseFormat) {
        var _a, _b, _c;
        if (isBaseFormat === void 0) { isBaseFormat = false; }
        var year, month, day;
        if (!this.isDate(value)) {
            var seperator = void 0;
            var dateFormat = void 0;
            if (ISO_DATE_REGEX.test(value)) {
                seperator = "-";
                dateFormat = "ymd";
            }
            else {
                seperator = ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.baseConfig && ReactiveFormConfig.json.baseConfig.seperator ? ReactiveFormConfig.json.baseConfig.seperator : "/";
                dateFormat = ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.baseConfig && ReactiveFormConfig.json.baseConfig.dateFormat ? ReactiveFormConfig.json.baseConfig.dateFormat : "mdy";
            }
            if (!isBaseFormat && ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.internationalization && ReactiveFormConfig.json.internationalization.dateFormat && ReactiveFormConfig.json.internationalization.seperator) {
                seperator = ReactiveFormConfig.json.internationalization.seperator;
                dateFormat = ReactiveFormConfig.json.internationalization.dateFormat;
            }
            switch (dateFormat) {
                case 'ymd':
                    _a = tslib_1.__read(value.split(seperator).map(function (val) { return +val; }), 3), year = _a[0], month = _a[1], day = _a[2];
                    break;
                case 'dmy':
                    _b = tslib_1.__read(value.split(seperator).map(function (val) { return +val; }), 3), day = _b[0], month = _b[1], year = _b[2];
                    break;
                case 'mdy':
                    _c = tslib_1.__read(value.split(seperator).map(function (val) { return +val; }), 3), month = _c[0], day = _c[1], year = _c[2];
                    break;
            }
            return new Date(year, month - 1, day);
        }
        else
            return value;
    };
    DateProvider.prototype.isValid = function (value) {
        if (typeof value == "string") {
            if (ISO_DATE_REGEX.test(value))
                return true;
            var seperator = '/';
            if (ReactiveFormConfig.json && ReactiveFormConfig.json.internationalization && ReactiveFormConfig.json.internationalization.seperator)
                seperator = ReactiveFormConfig.json.internationalization.seperator;
            value = value.replace(seperator, '-').replace(seperator, '-');
            return this.regex().test(value);
        }
        else
            return this.isDate(value);
    };
    DateProvider.prototype.getConfigDateValue = function (config) {
        var date = config.value;
        if (config.value && typeof config.value == "string") {
            date = this.getDate(config.value, true);
        }
        return date;
    };
    DateProvider.prototype.getCompareDate = function (config, control) {
        var date = this.getConfigDateValue(config);
        if (config.fieldName) {
            var checkControl = ApplicationUtil.getFormControl(config.fieldName, control);
            if (checkControl && checkControl.value) {
                date = this.getDate(checkControl.value);
            }
        }
        return date;
    };
    return DateProvider;
}());
export { DateProvider };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZS1wcm92aWRlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0ByeHdlYi9yZWFjdGl2ZS1mb3JtLXZhbGlkYXRvcnMvIiwic291cmNlcyI6WyJ1dGlsL2RhdGUtcHJvdmlkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzVELE9BQU8sRUFBQyxlQUFlLEVBQUUsTUFBTSxZQUFZLENBQUE7QUFDM0MsSUFBTSxjQUFjLEdBQUcsMkJBQTJCLENBQUM7QUFDbkQ7SUFBQTtJQWdHQSxDQUFDO0lBOUZDLDZCQUFNLEdBQU4sVUFBTyxLQUFVO1FBQ2YsT0FBTyxLQUFLLFlBQVksSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO0lBQzFELENBQUM7SUFFUywrQkFBUSxHQUFoQixVQUFpQixVQUFpQjtRQUNoQyxJQUFJLE1BQWEsQ0FBQztRQUNsQixRQUFPLFVBQVUsRUFBQztZQUNaLEtBQUssS0FBSztnQkFDVixNQUFNLEdBQUcsMkRBQTJELENBQUM7Z0JBQ3JFLE1BQU07WUFDTixLQUFLLEtBQUs7Z0JBQ1YsTUFBTSxHQUFHLG9FQUFvRSxDQUFDO2dCQUM5RSxNQUFNO1lBQ04sS0FBSyxLQUFLO2dCQUNWLE1BQU0sR0FBRyxvRUFBb0UsQ0FBQztnQkFDOUUsTUFBTTtTQUNYO1FBQ0QsT0FBTyxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM1QixDQUFDO0lBRUQsNEJBQUssR0FBTDtRQUNFLElBQUksTUFBYSxDQUFDO1FBQ2xCLElBQUcsa0JBQWtCLElBQUksa0JBQWtCLENBQUMsSUFBSSxJQUFJLGtCQUFrQixDQUFDLElBQUksQ0FBQyxvQkFBb0IsSUFBSSxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsVUFBVSxJQUFLLGtCQUFrQixDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxTQUFTO1lBQ3BO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Q0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBQyxPQUFPLENBQUMsQ0FBQztZQUNoRixJQUFHLFlBQVksSUFBSSxZQUFZLENBQUMsS0FBSyxFQUFDO2dCQUNsQyxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUE7YUFDdEM7U0FDRjtRQUNULE9BQU8sSUFBSSxDQUFDO0lBQ2xCLENBQUM7SUFDSCxtQkFBQztBQUFELENBQUMsQUFoR0QsSUFnR0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZWFjdGl2ZUZvcm1Db25maWcgfSBmcm9tIFwiLi9yZWFjdGl2ZS1mb3JtLWNvbmZpZ1wiO1xyXG5pbXBvcnQge0FwcGxpY2F0aW9uVXRpbCB9IGZyb20gJy4vYXBwLXV0aWwnXHJcbmNvbnN0IElTT19EQVRFX1JFR0VYID0gL14oXFxkezR9LVxcZHsxLDJ9LVxcZHsxLDJ9KSQvO1xyXG5leHBvcnQgY2xhc3MgRGF0ZVByb3ZpZGVye1xyXG5cclxuICBpc0RhdGUodmFsdWU6IGFueSk6IEJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4odmFsdWUudmFsdWVPZigpKTtcclxuICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRSZWdleChkYXRlRm9ybWF0OnN0cmluZykgOiBSZWdFeHB7XHJcbiAgICAgIHZhciByZWdFeHA6c3RyaW5nO1xyXG4gICAgICBzd2l0Y2goZGF0ZUZvcm1hdCl7XHJcbiAgICAgICAgICAgIGNhc2UgJ3ltZCc6XHJcbiAgICAgICAgICAgIHJlZ0V4cCA9IFwiXig/OlswLTldezR9KS0oMVswLTJdfDA/WzEtOV0pLSgzWzAxXXxbMTJdWzAtOV18MD9bMS05XSkkXCI7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdkbXknOlxyXG4gICAgICAgICAgICByZWdFeHAgPSBcIl4oM1swMV18WzEyXVswLTldfDA/WzEtOV0pLSgxWzAtMl18MD9bMS05XSktKD86WzAtOV17Mn0pP1swLTldezJ9JFwiO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnbWR5JzpcclxuICAgICAgICAgICAgcmVnRXhwID0gXCJeKDFbMC0yXXwwP1sxLTldKS0oM1swMV18WzEyXVswLTldfDA/WzEtOV0pLSg/OlswLTldezJ9KT9bMC05XXsyfSRcIjtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIG5ldyBSZWdFeHAocmVnRXhwKTtcclxuICAgIH1cclxuXHJcbiAgICByZWdleCgpe1xyXG4gICAgICB2YXIgcmVnRXhwOlJlZ0V4cDtcclxuICAgICAgaWYoUmVhY3RpdmVGb3JtQ29uZmlnICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uLmRhdGVGb3JtYXQgICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uLnNlcGVyYXRvcilcclxuICAgICAgICByZWdFeHAgPSB0aGlzLmdldFJlZ2V4KFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uLmRhdGVGb3JtYXQpXHJcbiAgICAgIGVsc2VcclxuICAgICAgICByZWdFeHAgPSAoUmVhY3RpdmVGb3JtQ29uZmlnICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmJhc2VDb25maWcgJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uYmFzZUNvbmZpZy5kYXRlRm9ybWF0KSA/IHRoaXMuZ2V0UmVnZXgoUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uYmFzZUNvbmZpZy5kYXRlRm9ybWF0KSA6IHRoaXMuZ2V0UmVnZXgoXCJtZHlcIik7XHJcbiAgICAgIHJldHVybiByZWdFeHA7XHJcbiAgICB9XHJcblxyXG4gIGdldERhdGUodmFsdWU6c3RyaW5nIHwgRGF0ZSxpc0Jhc2VGb3JtYXQ6Ym9vbGVhbiA9IGZhbHNlKTogRGF0ZXtcclxuICAgIGxldCB5ZWFyLG1vbnRoLGRheTtcclxuICAgIGlmKCF0aGlzLmlzRGF0ZSh2YWx1ZSkpe1xyXG4gICAgICBsZXQgc2VwZXJhdG9yOnN0cmluZztcclxuICAgICAgbGV0IGRhdGVGb3JtYXQ6c3RyaW5nO1xyXG4gICAgICBpZihJU09fREFURV9SRUdFWC50ZXN0KDxzdHJpbmc+dmFsdWUpKXtcclxuICAgICAgICBzZXBlcmF0b3IgPSBcIi1cIjtcclxuICAgICAgICBkYXRlRm9ybWF0ID0gXCJ5bWRcIlxyXG4gICAgICB9ZWxzZXtcclxuICAgICAgICBzZXBlcmF0b3IgPSBSZWFjdGl2ZUZvcm1Db25maWcgJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24gJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uYmFzZUNvbmZpZyAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5iYXNlQ29uZmlnLnNlcGVyYXRvciA/IFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmJhc2VDb25maWcuc2VwZXJhdG9yIDogXCIvXCI7XHJcbiAgICAgICAgZGF0ZUZvcm1hdCA9IFJlYWN0aXZlRm9ybUNvbmZpZyAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbiAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5iYXNlQ29uZmlnICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmJhc2VDb25maWcuZGF0ZUZvcm1hdCA/IFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmJhc2VDb25maWcuZGF0ZUZvcm1hdCA6IFwibWR5XCI7XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIGlmKCFpc0Jhc2VGb3JtYXQgJiYgUmVhY3RpdmVGb3JtQ29uZmlnICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uLmRhdGVGb3JtYXQgICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uLnNlcGVyYXRvcilcclxuICAgICAge1xyXG4gICAgICAgIHNlcGVyYXRvciA9IFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uLnNlcGVyYXRvcjtcclxuICAgICAgICBkYXRlRm9ybWF0ID0gUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uaW50ZXJuYXRpb25hbGl6YXRpb24uZGF0ZUZvcm1hdDtcclxuICAgICAgfVxyXG4gICAgICAgIHN3aXRjaChkYXRlRm9ybWF0KXtcclxuICAgICAgICAgICAgY2FzZSAneW1kJzpcclxuICAgICAgICAgICAgW3llYXIsIG1vbnRoLCBkYXldID0gKDxTdHJpbmc+dmFsdWUpLnNwbGl0KHNlcGVyYXRvcikubWFwKCh2YWw6IHN0cmluZykgPT4gK3ZhbCk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdkbXknOlxyXG4gICAgICAgICAgICBbZGF5LG1vbnRoLHllYXJdID0gKDxTdHJpbmc+dmFsdWUpLnNwbGl0KHNlcGVyYXRvcikubWFwKCh2YWw6IHN0cmluZykgPT4gK3ZhbCk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdtZHknOlxyXG4gICAgICAgICAgICBbbW9udGgsZGF5LHllYXJdID0gKDxTdHJpbmc+dmFsdWUpLnNwbGl0KHNlcGVyYXRvcikubWFwKCh2YWw6IHN0cmluZykgPT4gK3ZhbCk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHllYXIsbW9udGgtMSxkYXkpO1xyXG4gICAgfWVsc2VcclxuICAgICAgcmV0dXJuIDxEYXRlPnZhbHVlO1xyXG4gIH1cclxuXHJcbiAgaXNWYWxpZCh2YWx1ZTpzdHJpbmcgfCBEYXRlKSA6IEJvb2xlYW57XHJcbiAgICBpZih0eXBlb2YgdmFsdWUgPT0gXCJzdHJpbmdcIil7XHJcbiAgICAgIGlmKElTT19EQVRFX1JFR0VYLnRlc3QoPHN0cmluZz52YWx1ZSkpXHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIGxldCBzZXBlcmF0b3IgPSAnLydcclxuICAgICAgaWYoUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24gJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uaW50ZXJuYXRpb25hbGl6YXRpb24gJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uaW50ZXJuYXRpb25hbGl6YXRpb24uc2VwZXJhdG9yKVxyXG4gICAgICAgIHNlcGVyYXRvciA9IFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uLnNlcGVyYXRvcjtcclxuICAgICAgdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKHNlcGVyYXRvciwnLScpLnJlcGxhY2Uoc2VwZXJhdG9yLCctJyk7XHJcbiAgICAgIHJldHVybiB0aGlzLnJlZ2V4KCkudGVzdCh2YWx1ZSk7XHJcbiAgICB9ZWxzZVxyXG4gICAgICByZXR1cm4gdGhpcy5pc0RhdGUodmFsdWUpO1xyXG4gIH1cclxuXHJcbiAgZ2V0Q29uZmlnRGF0ZVZhbHVlKGNvbmZpZyl7XHJcbiAgICBsZXQgZGF0ZSA9IGNvbmZpZy52YWx1ZTtcclxuICAgIGlmKGNvbmZpZy52YWx1ZSAmJiB0eXBlb2YgY29uZmlnLnZhbHVlID09IFwic3RyaW5nXCIpe1xyXG4gICAgICBkYXRlID0gdGhpcy5nZXREYXRlKGNvbmZpZy52YWx1ZSx0cnVlKTtcclxuICAgIH1cclxuICAgIHJldHVybiBkYXRlO1xyXG4gIH1cclxuXHJcbiAgIGdldENvbXBhcmVEYXRlKGNvbmZpZzphbnksY29udHJvbDphbnkpe1xyXG4gICAgICAgICAgbGV0IGRhdGUgPSB0aGlzLmdldENvbmZpZ0RhdGVWYWx1ZShjb25maWcpO1xyXG4gICAgICAgICAgaWYoY29uZmlnLmZpZWxkTmFtZSl7XHJcbiAgICAgICAgICAgIGxldCBjaGVja0NvbnRyb2wgOiBhbnkgPSBBcHBsaWNhdGlvblV0aWwuZ2V0Rm9ybUNvbnRyb2woY29uZmlnLmZpZWxkTmFtZSxjb250cm9sKTtcclxuICAgICAgICAgICAgICBpZihjaGVja0NvbnRyb2wgJiYgY2hlY2tDb250cm9sLnZhbHVlKXtcclxuICAgICAgICAgICAgICAgICAgZGF0ZSA9IHRoaXMuZ2V0RGF0ZShjaGVja0NvbnRyb2wudmFsdWUpXHJcbiAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZGF0ZTtcclxuICB9XHJcbn1cclxuIl19